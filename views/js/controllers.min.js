define("taoSync/controller/routes",[],function(){"use strict";return{Synchronizer:{actions:{index:"taoSync/controller/synchronizer/index"}}}}),define("taoSync/controller/synchronizer/index",["jquery","lodash","moment","core/dataProvider/request","util/url","core/taskQueue/taskQueueModel","layout/loading-bar"],function($,_,moment,request,urlHelper,taskQueueModelFactory,loadingBar){"use strict";var tq={api:"TaskQueueWebApi",ext:"taoTaskQueue"},webservices={get:urlHelper.route("get",tq.api,tq.ext),archive:urlHelper.route("archive",tq.api,tq.ext),all:urlHelper.route("getAll",tq.api,tq.ext),download:urlHelper.route("download",tq.api,tq.ext),
lastTask:urlHelper.route("lastTask","Synchronizer","taoSync")};return{start:function(){function getData(){var data={label:"Data Synchronization"};return $formFields.each(function(){data[this.name]=this.value}),data}function toggleLaunchButtonState(){var isValid=!0;$formFields.each(function(){return isValid=this.validity.valid}),isValid?$launchButton.removeAttr("disabled"):$launchButton.attr("disabled","disabled")}function setState(state){$container.removeClass(function(index,className){return(className.match(/(^|\s)state-\S+/g)||[]).join(" ")}),$spinner["progress"===state?"addClass":"removeClass"]("spinner-icon"),$container.addClass("state-"+state),
msg.$all.hide()}function updateTime(taskData){setTime(taskData.createdAt,"$enqueued"),setTime(taskData.createdAt+taskData.createdAtElapsed,"$updated")}function setTime(timestamp,type){timeFields[type]&&timeFields[type].text(moment.unix(timestamp).format("LTS")),msg[type]&&msg[type].show()}function setHistoryTime(timestamp,type){setTime(timestamp,type),$container.addClass("history")}var $container=$("#tao-sync-container"),$form=$container.find("form"),$formFields=$form.find("input, select"),$launchButton=$form.find('button[data-control="launch"]'),$spinner=$form.find(".feedback-info .icon-loop"),timeFields={$enqueued:$form.find(".enqueue-time"),
$updated:$form.find(".update-time"),$completed:$form.find(".complete-time")},msg=function(){var _msg={$all:$form.find(".msg")};return _msg.$all.each(function(){var $currentMsg=$(this);_msg["$"+$currentMsg.data("type")]=$currentMsg}),_msg}(),taskQueue=taskQueueModelFactory({url:{get:webservices.get,archive:webservices.archive,all:webservices.all,download:webservices.download},pollSingleIntervals:[{iteration:Number.MAX_SAFE_INTEGER,interval:2e3}],pollAllIntervals:[{iteration:1,interval:8e3},{iteration:0,interval:5e3}]}).on("pollSingleFinished",function(taskId,taskData){"completed"===taskData.status?(setState("success"),updateTime(taskData),
setHistoryTime(taskData.updatedAt,"$completed")):"failed"===taskData.status&&setState("error")}).on("pollSingle",function(taskId,taskData){updateTime(taskData)}).on("error",function(){setState("error")});$container.find(".fb-container").removeClass("viewport-hidden"),loadingBar.start(),$formFields.on("keyup paste blur",toggleLaunchButtonState),toggleLaunchButtonState(),$form.on("submit",function(e){e.preventDefault(),setState("progress"),taskQueue.create(this.action,getData())}),$form.find('button[data-control="close"]').on("click",function(e){e.preventDefault(),setState("form")}),request(webservices.lastTask).then(function(currentTask){
if(currentTask&&currentTask.status)switch(currentTask.status){case"failed":setState("error");break;case"completed":setState("form"),updateTime(currentTask),setHistoryTime(currentTask.updatedAt,"$completed");break;default:setState("progress"),updateTime(currentTask),taskQueue.pollSingle(currentTask.id)}else setState("form");loadingBar.stop()}).catch(function(){setState("error")})}}});
//# sourceMappingURL=controllers.min.js.map