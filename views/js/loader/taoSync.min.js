define("taoSync/controller/routes",[],function(){"use strict";return{Synchronizer:{actions:{index:"taoSync/controller/synchronizer/index"}},SynchronizationHistory:{actions:{index:"taoSync/controller/SynchronizationHistory/index"}}}}),define("tpl!taoSync/component/synchronization/detailedReport",["handlebars"],function(hb){return hb.template(function(helper,depth0,helpers,partials,stack1){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,helper.helpers),stack1=stack1||{};var options,buffer="",functionType="function",escapeExpression=this.escapeExpression,helperMissing=helpers.helperMissing
;return buffer+='<div class="modal sync-report-modal">\n    <section>\n        <h1>\n            '+escapeExpression((options={hash:{},data:stack1},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"Synchronization report data",options):helperMissing.call(depth0,"__","Synchronization report data",options)))+"\n        </h1>\n        ",!(stack1=helpers.each.call(depth0,depth0&&depth0.data,{hash:{},inverse:this.noop,fn:this.program(1,function(depth0,stack1){var buffer="";return buffer+="\n        <h2>"+escapeExpression(typeof(stack1=null==stack1||!1===stack1?stack1:stack1.key)===functionType?stack1.apply(depth0):stack1
)+":</h2>\n        <div><pre>"+escapeExpression(typeof depth0===functionType?depth0.apply(depth0):depth0)+"</pre></div>\n        <hr>\n        "},stack1),data:stack1}))&&0!==stack1||(buffer+=stack1),buffer+="\n    </section>\n</div>"})}),define("tpl!taoSync/component/synchronization/list",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),'<div class="component results-list">\n    <div class="list"></div>\n</div>'})}),define("taoSync/component/synchronization/list",["jquery","i18n","lodash","uri","core/promise","ui/component",
"tpl!taoSync/component/synchronization/list","ui/datatable"],function($,__,_,uri,Promise,component,listTpl){"use strict";return function(config){var syncHistoryList;if(!_.isPlainObject(config))throw new TypeError("The configuration is required");if(!_.isPlainObject(config.model)&&!_.isArray(config.model))throw new TypeError("The data model is required");return(syncHistoryList=component({})).on("render",function(){this.getElement().datatable({sortby:config.sortby,sortorder:config.sortorder,url:config.dataUrl,model:config.model,actions:config.actions})}).setTemplate(listTpl),syncHistoryList.init()}}),define("taoSync/controller/SynchronizationHistory/index",[
"jquery","lodash","i18n","module","core/logger","util/url","layout/actions/binder","layout/loading-bar","ui/feedback","tpl!taoSync/component/synchronization/detailedReport","taoSync/component/synchronization/list"],function($,_,__,module,loggerFactory,urlHelper,binder,loadingBar,feedback,layout,syncHistoryListFactory){"use strict";var $table,logger=loggerFactory("controller/SynchronizationHistory/index");function reportError(err){loadingBar.stop(),logger.error(err),err instanceof Error&&feedback().error(err.message)}function viewReport(rowId){loadingBar.start(),$.ajax({url:urlHelper.route("viewReport","SynchronizationHistory","taoSync",{id:rowId}),
type:"GET",success:function(result){"object"==typeof result&&null!==result&&Object.keys(result).forEach(function(key){"object"==typeof result[key]&&result[key],result[key]=JSON.stringify(result[key],null,1)});var $container=$(layout({data:result}));$("#sync-history").append($container),$container.modal({startClosed:!0,minWidth:450}),$container.modal("open"),loadingBar.stop()},error:function(message,err){message=getRequestErrorMessage(message);feedback().error(message,{encodeHtml:!1}),loadingBar.stop()}})}return{start:function(){var listConfig=module.config()||{},actions={view:{action:viewReport,id:"view",label:__("View"),title:__("Detail view"),icon:"view"}}
,listConfig=listConfig.dataModel;listConfig.data.transform=function(value,row){return value.replace(/\n/g,"<br />")};listConfig={sortby:"created_at",sortorder:"desc",dataUrl:urlHelper.route("getHistory","SynchronizationHistory","taoSync",{}),model:listConfig,actions:actions};($table=$("#sync-history")).length?(loadingBar.start(),syncHistoryListFactory(listConfig,actions).on("error",reportError).on("success",function(message){feedback().success(message)}).before("loading",function(){loadingBar.start()}).after("loaded",function(){loadingBar.stop()}).render($(".sync-history-grid",$table))):loadingBar.stop()}}}),define(
"tpl!taoSync/component/terminateExecutions/notification",["handlebars"],function(hb){return hb.template(function(options,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,options.helpers),data=data||{};var stack1,helper,buffer="",functionType="function",escapeExpression=this.escapeExpression,helperMissing=helpers.helperMissing;return buffer+='<div class="component termination-area">\n    <section class="fb-container">\n        <div class="feedback-warning status-active">\n            <span class="icon-warning"></span>\n            <div class="notification-message">\n                <p>\n                    ',stack1=(
helper=helpers.notificationMessage)||typeof(helper=depth0&&depth0.notificationMessage)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+'\n                </p>\n            </div>\n\n            <div class="in-progress-list">\n                <p class="b">'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"Assessments in progress:",options):helperMissing.call(depth0,"__","Assessments in progress:",options)))+"</p>\n                <ul>\n                    ",!(stack1=helpers.each.call(depth0,depth0&&depth0.aggregatedData,{hash:{},inverse:this.noop,
fn:this.program(1,function(depth0,data){var stack1,buffer="";return buffer+="\n                        <li>- "+escapeExpression(typeof(stack1=depth0&&depth0.label)===functionType?stack1.apply(depth0):stack1)+" / "+escapeExpression(typeof(stack1=depth0&&depth0.total)===functionType?stack1.apply(depth0):stack1)+"</li>\n                    "},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+='\n                </ul>\n            </div>\n        </div>\n\n\n        <div class="button-area">\n            <span class="btn-info cancel-button">\n                <span class="icon-close"></span>\n                '+escapeExpression((options={hash:{},data:data},(
helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"Cancel",options):helperMissing.call(depth0,"__","Cancel",options)))+'\n            </span>\n\n            <span class="btn-warning force-terminate-button">\n                <span class="icon-warning"></span>\n                '+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"Force end and synchronize",options):helperMissing.call(depth0,"__","Force end and synchronize",options)))+"\n            </span>\n        </div>\n    <div>\n</div>"})}),define("taoSync/component/terminateExecutions/terminateExecutions",["i18n","lodash","core/request",
"ui/component","tpl!taoSync/component/terminateExecutions/notification"],function(__,_,request,component,listTpl){"use strict";return function($container,config){if(!_.isPlainObject(config))throw new TypeError("The configuration is required");return component({}).setTemplate(listTpl).on("init",function(){config.activeExecutions=[],config.aggregatedData={},config.notificationMessage=(1<config.data.length?__("There are %s assessments in progress",config.data.length):__("There is one assessment in progress"))+", "+__("please ensure that everyone has completed the assessment before proceeding."),_.forEach(config.data,function(execution){
config.activeExecutions.push(execution.execution_id),config.aggregatedData[execution.context_id]=config.aggregatedData[execution.context_id]||{total:0},config.aggregatedData[execution.context_id].label=execution.label,config.aggregatedData[execution.context_id].total++}),this.config=config}).on("render",function(){var self=this;$container.find(".cancel-button").on("click",function(e){e.preventDefault(),self.trigger("terminationCanceled"),self.destroy()}),$container.find(".force-terminate-button").on("click",function(data){data.preventDefault(),data={executionsId:config.activeExecutions},request({url:config.terminateUrl,data:data,method:"POST",noToken:!1}
).then(function(response){self.trigger("terminationSucceeded"),self.destroy()}).catch(function(error){self.trigger("terminationFailed")})}),self.trigger("dialogRendered")}).init(config)}}),define("taoSync/component/readinessDashboard/readinessDashboard",["i18n","lodash","core/eventifier","core/promise","ui/dashboard","core/dataProvider/request","util/url"],function(__,_,eventifier,Promise,dashboard,request,urlHelper){"use strict";return function($container){return eventifier({performChecks:function(){var self=this;new Promise(function(resolve){request(urlHelper.route("getMachineChecks","Synchronizer","taoSync")).then(function(data){resolve(data)})}).then(
function(data){self.dashboard.toggleLoadingBar(!1),self.dashboard.renderMetrics(data)})},render:function(){return this.dashboard=dashboard({renderTo:$container,loading:!0,warningText:!1,layoutType:"list"}),this.performChecks(),this},destroy:function(){return this.dashboard&&this.dashboard.destroy(),this.trigger("destroy"),this}})}}),define("taoSync/controller/synchronizer/index",["i18n","jquery","lodash","moment","core/dataProvider/request","util/url","ui/taskQueue/taskQueueModel","layout/loading-bar","taoSync/component/terminateExecutions/terminateExecutions","taoSync/component/readinessDashboard/readinessDashboard","core/promise","ui/filesender"],function(
__,$,_,moment,request,urlHelper,taskQueueModelFactory,loadingBar,terminateExecutionsDialogFactory,readinessDashboardFactory,Promise){"use strict";var tq_api="TaskQueueWebApi",tq_ext="taoTaskQueue",webservices={get:urlHelper.route("get",tq_api,tq_ext),archive:urlHelper.route("archive",tq_api,tq_ext),all:urlHelper.route("getAll",tq_api,tq_ext),download:urlHelper.route("download",tq_api,tq_ext),lastTask:urlHelper.route("lastTask","Synchronizer","taoSync"),activeSessions:urlHelper.route("activeSessions","Synchronizer","taoSync"),terminateExecutions:urlHelper.route("terminateExecutions","TerminateExecution","taoSync"),exportSyncData:urlHelper.route("createTask",
"Exporter","taoSync"),importSyncData:urlHelper.route("createTask","Importer","taoSync")},defaultSyncMessages={error:__("The synchronization process has failed."),progress:__("Synchronization in progress."),success:__("Success! The synchronization process has been finished.")};return{start:function(){var readinessDashboard,terminateExecutionsDialog,_msg,$container=$("#tao-sync-container"),$syncForm=$container.find("form.sync-form"),$syncFormFields=($container.find("form.sync-form"),$syncForm.find('input:not([type="file"]), select')),$launchButton=$syncForm.find('button[data-control="launch"]'),$spinner=$syncForm.find(".feedback-info .icon-loop"),timeFields={
$enqueued:$syncForm.find(".enqueue-time"),$updated:$syncForm.find(".update-time"),$completed:$syncForm.find(".complete-time")},msg=((_msg={$all:$syncForm.find(".msg")}).$all.each(function(){var $currentMsg=$(this);_msg["$"+$currentMsg.data("type")]=$currentMsg}),_msg),taskQueue=taskQueueModelFactory({url:{get:webservices.get,archive:webservices.archive,all:webservices.all,download:webservices.download},pollSingleIntervals:[{iteration:Number.MAX_SAFE_INTEGER,interval:2e3}],pollAllIntervals:[{iteration:1,interval:8e3},{iteration:0,interval:5e3}]}).on("pollSingleFinished",function(taskId,taskData){
"completed"===taskData.status?"oat\\taoSync\\scripts\\tool\\Export\\ExportSynchronizationPackage"===taskData.taskName?(setState("success",__("Synchronization data is ready to be downloaded. Downloading process will start in the background.")),taskQueue.download(taskId)):"oat\\taoSync\\scripts\\tool\\Import\\ImportSynchronizationPackage"===taskData.taskName?setState("success",__("Synchronization data has been imported."),!0):(setState("success"),updateTime(taskData),setHistoryTime(taskData.updatedAt,"$completed")):"failed"===taskData.status&&setState("error")}).on("pollSingle",function(taskId,taskData){updateTime(taskData)}).on("error",function(error){
error.response&&400<=error.response.errorCode&&error.response.errorCode<500?setState("error",error.response.errorMsg):setState("error")});function getData(){var data={label:"Data Synchronization"};return $syncFormFields.each(function(){data[this.name]=this.value}),data}function toggleLaunchButtonState(){var isValid=!0;$syncFormFields.each(function(){return isValid=this.validity.valid}),isValid?$launchButton.removeAttr("disabled"):$launchButton.attr("disabled","disabled")}function setState($dashboardContainer,message,hideDashboard){var statusClassName=".status-"+$dashboardContainer;$container.find(statusClassName+" .messages p span:first-child").text(
message||defaultSyncMessages[$dashboardContainer]),$container.removeClass(function(index,className){return(className.match(/(^|\s)state-\S+/g)||[]).join(" ")}),$spinner["progress"===$dashboardContainer?"addClass":"removeClass"]("spinner-icon"),$container.addClass("state-"+$dashboardContainer),msg.$all.hide(),"success"!==$dashboardContainer&&"error"!==$dashboardContainer||hideDashboard?"progress"===$dashboardContainer&&(readinessDashboard&&readinessDashboard.destroy(),readinessDashboard=null):($dashboardContainer=$container.find("#dashboard-container"),readinessDashboard=readinessDashboardFactory($dashboardContainer).render())}function updateTime(taskData){
setTime(taskData.createdAt,"$enqueued"),setTime(taskData.createdAt+taskData.createdAtElapsed,"$updated")}function setTime(timestamp,type){timeFields[type]&&timeFields[type].text(moment.unix(timestamp).format("LTS")),msg[type]&&msg[type].show()}function setHistoryTime(timestamp,type){setTime(timestamp,type),$container.addClass("history")}function checkActiveSessions(){return request(webservices.activeSessions).then(function(data){return terminateExecutionsDialog&&(terminateExecutionsDialog.destroy(),terminateExecutionsDialog=null),!(Array.isArray(data.activeSessionsData)&&0<data.activeSessionsData.length)||function(data){
var $terminateActionContainer=$container.find(".terminate-action"),$syncActionContainer=$container.find(".sync-action"),dialogConfig={data:data.activeSessionsData,terminateUrl:webservices.terminateExecutions};return new Promise(function(resolve,reject){terminateExecutionsDialog=terminateExecutionsDialogFactory($terminateActionContainer,dialogConfig).on("dialogRendered",function(){$syncActionContainer.toggle(),$terminateActionContainer.toggle()}).on("terminationCanceled",function(){$terminateActionContainer.toggle(),$syncActionContainer.toggle(),resolve(!1)}).on("terminationFailed",function(){reject()}).on("terminationSucceeded",function(){
$terminateActionContainer.toggle(),$syncActionContainer.toggle(),resolve(!0)}).render($terminateActionContainer)})}(data)})}$container.find(".fb-container").removeClass("viewport-hidden"),loadingBar.start(),$syncFormFields.on("keyup paste blur",toggleLaunchButtonState),toggleLaunchButtonState(),$syncForm.on("submit",function(e){var action=this.action;e.preventDefault(),setState("progress"),$container.removeClass("active"),checkActiveSessions().then(function(canStartSynchronization){canStartSynchronization?taskQueue.create(action,getData()):setState("form")}).catch(function(){setState("error")})}),$syncForm.find('button[data-control="close"]').on("click",
function(e){e.preventDefault(),setState("form")}),$syncForm.find('a[data-control="export"]').on("click",function(e){setState("progress",__("Preparation of synchronization data is in progress.")),checkActiveSessions().then(function(canStartSynchronization){canStartSynchronization?taskQueue.create(urlHelper.build(webservices.exportSyncData,getData())):setState("form")}).catch(function(){setState("error")})}),$syncForm.find('input[data-control="import"]').on("change",function(e){e.target.files[0]&&(setState("progress",__("Import of synchronization data is in progress.")),$syncForm.sendfile({url:webservices.importSyncData,loaded:function(response){
taskQueue.pollSingle(response.data.task.id)},failed:function(){setState("error")}}))}),request(webservices.lastTask).then(function(currentTask){if(currentTask&&currentTask.status)switch(currentTask.status){case"failed":setState("error");break;case"completed":setState("form"),updateTime(currentTask),setHistoryTime(currentTask.updatedAt,"$completed");break;default:setState("progress"),updateTime(currentTask),taskQueue.pollSingle(currentTask.id)}else setState("form");loadingBar.stop()}).catch(function(){setState("error")})}}}),define("taoSync/loader/taoSync.bundle",function(){});
//# sourceMappingURL=taoSync.min.js.map