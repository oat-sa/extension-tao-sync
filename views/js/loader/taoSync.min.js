define("taoSync/controller/routes",[],function(){"use strict";return{Synchronizer:{actions:{index:"taoSync/controller/synchronizer/index"}},SynchronizationHistory:{actions:{index:"taoSync/controller/SynchronizationHistory/index"}}}}),define("tpl!taoSync/component/synchronization/detailedReport",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",functionType="function",escapeExpression=this.escapeExpression,helperMissing=helpers.helperMissing
;return buffer+='<div class="modal sync-report-modal">\r\n    <section>\r\n        <h1>\r\n            '+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"Synchronization report data",options):helperMissing.call(depth0,"__","Synchronization report data",options)))+"\r\n        </h1>\r\n        ",((stack1=helpers.each.call(depth0,depth0&&depth0.data,{hash:{},inverse:this.noop,fn:this.program(1,function(depth0,data){var stack1,buffer="";return buffer+="\r\n        <h2>"+escapeExpression(typeof(stack1=null==data||!1===data?data:data.key)===functionType?stack1.apply(depth0):stack1
)+":</h2>\r\n        <div><pre>"+escapeExpression(typeof depth0===functionType?depth0.apply(depth0):depth0)+"</pre></div>\r\n        <hr>\r\n        "},data),data:data}))||0===stack1)&&(buffer+=stack1),buffer+="\r\n    </section>\r\n</div>"})}),define("tpl!taoSync/component/synchronization/list",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},'<div class="component results-list">\r\n    <div class="list"></div>\r\n</div>'})}),define("taoSync/component/synchronization/list",["jquery","i18n","lodash","uri",
"core/promise","ui/component","tpl!taoSync/component/synchronization/list","ui/datatable"],function($,__,_,uri,Promise,component,listTpl){"use strict";return function(config){var syncHistoryList;if(!_.isPlainObject(config))throw new TypeError("The configuration is required");if(!_.isPlainObject(config.model)&&!_.isArray(config.model))throw new TypeError("The data model is required");return(syncHistoryList=component({})).on("render",function(){this.getElement().datatable({sortby:config.sortby,sortorder:config.sortorder,url:config.dataUrl,model:config.model,actions:config.actions})}).setTemplate(listTpl),syncHistoryList.init()}}),define(
"taoSync/controller/SynchronizationHistory/index",["jquery","lodash","i18n","module","core/logger","util/url","layout/actions/binder","layout/loading-bar","ui/feedback","tpl!taoSync/component/synchronization/detailedReport","taoSync/component/synchronization/list"],function($,_,__,module,loggerFactory,urlHelper,binder,loadingBar,feedback,layout,syncHistoryListFactory){"use strict";var $table,logger=loggerFactory("controller/SynchronizationHistory/index");function reportError(err){loadingBar.stop(),logger.error(err),err instanceof Error&&feedback().error(err.message)}function viewReport(rowId){loadingBar.start(),$.ajax({url:urlHelper.route("viewReport",
"SynchronizationHistory","taoSync",{id:rowId}),type:"GET",success:function(result){"object"==typeof result&&null!==result&&Object.keys(result).forEach(function(key){"object"==typeof result[key]&&result[key],result[key]=JSON.stringify(result[key],null,1)});var $container=$(layout({data:result}));$("#sync-history").append($container),$container.modal({startClosed:!0,minWidth:450}),$container.modal("open"),loadingBar.stop()},error:function(xhr,err){var message=getRequestErrorMessage(xhr);feedback().error(message,{encodeHtml:!1}),loadingBar.stop()}})}return{start:function(){var model=[{id:"status",label:__("Result"),sortable:!0},{id:"created_at",label:__("Time"
),sortable:!0},{id:"data",label:__("Data"),transform:function(value,row){return value.replace(/\n/g,"<br />")}},{id:"organisation",label:__("Organisation ID")}],actions={view:{action:viewReport,id:"view",label:__("View"),title:__("Detail view"),icon:"view"}},listConfig=(module.config(),{sortby:"created_at",sortorder:"desc",dataUrl:urlHelper.route("getHistory","SynchronizationHistory","taoSync",{}),model:model,actions:actions});($table=$("#sync-history")).length?(loadingBar.start(),syncHistoryListFactory(listConfig,actions).on("error",reportError).on("success",function(message){feedback().success(message)}).before("loading",function(){loadingBar.start()}
).after("loaded",function(){loadingBar.stop()}).render($(".sync-history-grid",$table))):loadingBar.stop()}}}),define("taoSync/controller/synchronizer/index",["jquery","lodash","moment","core/dataProvider/request","util/url","core/taskQueue/taskQueueModel","layout/loading-bar"],function($,_,moment,request,urlHelper,taskQueueModelFactory,loadingBar){"use strict";var tq_api="TaskQueueWebApi",tq_ext="taoTaskQueue",webservices={get:urlHelper.route("get",tq_api,tq_ext),archive:urlHelper.route("archive",tq_api,tq_ext),all:urlHelper.route("getAll",tq_api,tq_ext),download:urlHelper.route("download",tq_api,tq_ext),lastTask:urlHelper.route("lastTask","Synchronizer",
"taoSync"),activeSessions:urlHelper.route("activeSessions","Synchronizer","taoSync")};return{start:function(){var _msg,$container=$("#tao-sync-container"),$form=$container.find("form"),$formFields=$form.find("input, select"),$launchButton=$form.find('button[data-control="launch"]'),$spinner=$form.find(".feedback-info .icon-loop"),timeFields={$enqueued:$form.find(".enqueue-time"),$updated:$form.find(".update-time"),$completed:$form.find(".complete-time")},msg=((_msg={$all:$form.find(".msg")}).$all.each(function(){var $currentMsg=$(this);_msg["$"+$currentMsg.data("type")]=$currentMsg}),_msg),taskQueue=taskQueueModelFactory({url:{get:webservices.get,
archive:webservices.archive,all:webservices.all,download:webservices.download},pollSingleIntervals:[{iteration:Number.MAX_SAFE_INTEGER,interval:2e3}],pollAllIntervals:[{iteration:1,interval:8e3},{iteration:0,interval:5e3}]}).on("pollSingleFinished",function(taskId,taskData){"completed"===taskData.status?(setState("success"),updateTime(taskData),setHistoryTime(taskData.updatedAt,"$completed")):"failed"===taskData.status&&setState("error")}).on("pollSingle",function(taskId,taskData){updateTime(taskData)}).on("error",function(){setState("error")});function toggleLaunchButtonState(){var isValid=!0;$formFields.each(function(){return isValid=this.validity.valid}),
isValid?$launchButton.removeAttr("disabled"):$launchButton.attr("disabled","disabled")}function setState(state){$container.removeClass(function(index,className){return(className.match(/(^|\s)state-\S+/g)||[]).join(" ")}),$spinner["progress"===state?"addClass":"removeClass"]("spinner-icon"),$container.addClass("state-"+state),msg.$all.hide()}function updateTime(taskData){setTime(taskData.createdAt,"$enqueued"),setTime(taskData.createdAt+taskData.createdAtElapsed,"$updated")}function setTime(timestamp,type){timeFields[type]&&timeFields[type].text(moment.unix(timestamp).format("LTS")),msg[type]&&msg[type].show()}function setHistoryTime(timestamp,type){setTime(
timestamp,type),$container.addClass("history")}$container.find(".fb-container").removeClass("viewport-hidden"),loadingBar.start(),$formFields.on("keyup paste blur",toggleLaunchButtonState),toggleLaunchButtonState(),$form.on("submit",function(e){var action=this.action;e.preventDefault(),setState("progress"),$container.removeClass("active"),request(webservices.activeSessions).then(function(data){0<data.activeSessions?(setState("form"),$container.addClass("active"),$container.removeClass("history"),loadingBar.stop()):taskQueue.create(action,function(){var data={label:"Data Synchronization"};return $formFields.each(function(){data[this.name]=this.value}),data}()
)}).catch(function(){setState("error")})}),$form.find('button[data-control="close"]').on("click",function(e){e.preventDefault(),setState("form")}),request(webservices.lastTask).then(function(currentTask){if(currentTask&&currentTask.status)switch(currentTask.status){case"failed":setState("error");break;case"completed":setState("form"),updateTime(currentTask),setHistoryTime(currentTask.updatedAt,"$completed");break;default:setState("progress"),updateTime(currentTask),taskQueue.pollSingle(currentTask.id)}else setState("form");loadingBar.stop()}).catch(function(){setState("error")})}}}),define("taoSyncloader\taoSync.bundle",function(){});
//# sourceMappingURL=taoSync.min.js.map